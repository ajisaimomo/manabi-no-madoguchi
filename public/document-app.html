<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“„ å­¦ç¿’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'BIZ UDPã‚´ã‚·ãƒƒã‚¯', 'Yu Gothic UI', 'Meiryo UI', 'Hiragino Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            min-height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .toolbar {
            background: #f8f9ff;
            padding: 15px 20px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            min-height: 40px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #48bb78, #38a169);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #fc8181, #f56565);
        }
        
        .filename-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        
        .filename-input {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            width: 200px;
        }
        
        .editor-container {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .editor {
            flex: 1;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            font-size: 16px;
            line-height: 2.2;
            min-height: 500px;
            outline: none;
            transition: border-color 0.3s ease;
            overflow-y: auto;
            position: relative;
        }
        
        .editor:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .editor p {
            margin-bottom: 1em;
        }
        
        .editor ruby {
            ruby-align: start;
            ruby-position: over;
        }
        
        .editor ruby rt {
            font-size: 8px;
            color: #666;
            font-weight: normal;
        }
        
        /* ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
        .editor.empty::before {
            content: "ğŸ“š å­¦ç¿’(ãŒãã—ã‚…ã†)ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ\A\Aä½œæˆæ—¥(ã•ãã›ã„ã³): " attr(data-date) "\A\Aã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ–‡ç« (ã¶ã‚“ã—ã‚‡ã†)ã‚’æ›¸(ã‹)ã“ã†ï¼\A\AğŸ’¡ ã‹ã‚“ãŸã‚“ãªä½¿(ã¤ã‹)ã„æ–¹(ã‹ãŸ):\Aâ‘  èª¿(ã—ã‚‰)ã¹ã‚‹çª“å£(ã¾ã©ãã¡)ã§ã‚³ãƒ”ãƒ¼\Aâ‘¡ ã“ã“ã«è²¼(ã¯)ã‚Šä»˜(ã¤)ã‘\Aâ‘¢ ä¿å­˜(ã»ãã‚“)ãƒ»å°åˆ·(ã„ã‚“ã•ã¤)";
            white-space: pre-line;
            color: #999;
            font-style: italic;
            pointer-events: none;
            position: absolute;
            top: 20px;
            left: 20px;
            line-height: 2.2;
            font-size: 15px;
        }
        
        .status-bar {
            background: #f8f9ff;
            padding: 10px 20px;
            border-top: 1px solid #e2e8f0;
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .word-count {
            font-weight: 600;
        }
        
        .a4-info {
            font-size: 11px;
            color: #888;
            display: flex;
            gap: 15px;
        }
        
        .last-saved {
            font-style: italic;
        }
        
        /* A4å°åˆ·æœ€é©åŒ– */
        @media print {
            body {
                background: white;
                padding: 0;
                font-size: 11pt;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
                min-height: auto;
                max-width: none;
            }
            
            .header, .toolbar, .status-bar {
                display: none;
            }
            
            .editor-container {
                padding: 0;
            }
            
            .editor {
                border: none;
                box-shadow: none;
                min-height: auto;
                font-size: 11pt;
                line-height: 1.8;
                padding: 20mm 15mm;
                page-break-inside: avoid;
            }
            
            .editor ruby rt {
                font-size: 5.5pt;
            }
            
            .editor p {
                margin-bottom: 0.8em;
                page-break-inside: avoid;
                orphans: 2;
                widows: 2;
            }
            
            @page {
                size: A4;
                margin: 20mm 15mm;
            }
        }
        
        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filename-group {
                margin-left: 0;
                justify-content: stretch;
            }
            
            .filename-input {
                width: 100%;
            }
            
            .btn {
                justify-content: center;
                width: 100%;
            }
            
            .a4-info {
                flex-direction: column;
                gap: 5px;
            }
        }
        
        /* é€šçŸ¥ã‚¹ã‚¿ã‚¤ãƒ« */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #48bb78;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #f56565;
        }
        
        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .preview-modal.show {
            display: flex;
        }
        
        .preview-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            height: 90%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .preview-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-header h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .preview-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-close:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .preview-body {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        
        .preview-page {
            width: 210mm;
            min-height: 297mm;
            margin: 20px auto;
            padding: 20mm 15mm;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            background: white;
            font-family: 'BIZ UDPã‚´ã‚·ãƒƒã‚¯', 'Yu Gothic UI', 'Meiryo UI', 'Hiragino Sans', sans-serif;
            font-size: 11pt;
            line-height: 1.8;
            color: #333;
            box-sizing: border-box;
            transform: scale(0.6);
            transform-origin: top center;
        }
        
        .preview-page ruby {
            ruby-align: start;
            ruby-position: over;
        }
        
        .preview-page ruby rt {
            font-size: 5.5pt;
            color: #666;
            font-weight: normal;
        }
        
        .preview-page p {
            margin-bottom: 0.8em;
        }
        
        .preview-buttons {
            padding: 15px 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .preview-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .preview-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .preview-btn.secondary {
            background: linear-gradient(45deg, #48bb78, #38a169);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“„ <ruby>å­¦<rt>ãŒã</rt></ruby><ruby>ç¿’<rt>ã—ã‚…ã†</rt></ruby>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ<ruby>ä½œ<rt>ã•ã</rt></ruby><ruby>æˆ<rt>ã›ã„</rt></ruby></h1>
            <p><ruby>èª¿<rt>ã—ã‚‰</rt></ruby>ã¹ãŸ<ruby>å†…<rt>ãªã„</rt></ruby><ruby>å®¹<rt>ã‚ˆã†</rt></ruby>ã‚’ã¾ã¨ã‚ã¦ã€<ruby>ä¿<rt>ã»</rt></ruby><ruby>å­˜<rt>ãã‚“</rt></ruby>ãƒ»<ruby>å°<rt>ã„ã‚“</rt></ruby><ruby>åˆ·<rt>ã•ã¤</rt></ruby>ã—ã‚ˆã†</p>
        </div>
        
        <div class="toolbar">
            <button class="btn" onclick="newDocument()">
                ğŸ“„ <ruby>æ–°<rt>ã—ã‚“</rt></ruby><ruby>è¦<rt>ã</rt></ruby><ruby>ä½œ<rt>ã•ã</rt></ruby><ruby>æˆ<rt>ã›ã„</rt></ruby>
            </button>
            <button class="btn btn-secondary" onclick="loadDocument()">
                ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«<ruby>èª­<rt>ã‚ˆ</rt></ruby>ã¿<ruby>è¾¼<rt>ã“</rt></ruby>ã¿
            </button>
            <button class="btn btn-secondary" onclick="saveDocument()">
                ğŸ’¾ <ruby>ä¿<rt>ã»</rt></ruby><ruby>å­˜<rt>ãã‚“</rt></ruby>
            </button>
            <button class="btn" onclick="printDocument()">
                ğŸ–¨ï¸ <ruby>å°<rt>ã„ã‚“</rt></ruby><ruby>åˆ·<rt>ã•ã¤</rt></ruby>
            </button>
            <button class="btn" onclick="showPrintPreview()">
                ğŸ‘€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            </button>
            <button class="btn btn-danger" onclick="clearDocument()">
                ğŸ—‘ï¸ <ruby>æ¶ˆ<rt>ã—ã‚‡ã†</rt></ruby><ruby>å»<rt>ãã‚‡</rt></ruby>
            </button>
            <button class="btn" onclick="openHelp()">
                â“ <ruby>ä½¿<rt>ã¤ã‹</rt></ruby>ã„<ruby>æ–¹<rt>ã‹ãŸ</rt></ruby>
            </button>
            
            <div class="filename-group">
                <label for="filename">ãƒ•ã‚¡ã‚¤ãƒ«<ruby>å<rt>ã‚ã„</rt></ruby>:</label>
                <input type="text" id="filename" class="filename-input" value="å­¦ç¿’è³‡æ–™" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›">
                <span>.html</span>
            </div>
        </div>
        
        <div class="editor-container">
            <div id="editor" class="editor empty" contenteditable="true" data-date=""></div>
        </div>
        
        <div class="status-bar">
            <div class="word-count">
                <ruby>æ–‡<rt>ã‚‚ã˜</rt></ruby><ruby>å­—<rt>ã˜</rt></ruby><ruby>æ•°<rt>ã™ã†</rt></ruby>: <span id="charCount">0</span><ruby>æ–‡<rt>ã‚‚</rt></ruby><ruby>å­—<rt>ã˜</rt></ruby>
            </div>
            <div class="a4-info">
                <span>ğŸ“„ A4<ruby>ç”¨<rt>ã‚ˆã†</rt></ruby><ruby>ç´™<rt>ã—</rt></ruby><ruby>æœ€<rt>ã•ã„</rt></ruby><ruby>é©<rt>ã¦ã</rt></ruby><ruby>åŒ–<rt>ã‹</rt></ruby>æ¸ˆã¿</span>
                <span>ğŸ“ <ruby>ç›®<rt>ã‚</rt></ruby><ruby>å®‰<rt>ã‚„ã™</rt></ruby>: 1,000-1,500<ruby>æ–‡<rt>ã‚‚</rt></ruby><ruby>å­—<rt>ã˜</rt></ruby>/ãƒšãƒ¼ã‚¸</span>
            </div>
            <div class="last-saved">
                <ruby>æœ€<rt>ã•ã„</rt></ruby><ruby>çµ‚<rt>ã—ã‚…ã†</rt></ruby><ruby>æ›´<rt>ã“ã†</rt></ruby><ruby>æ–°<rt>ã—ã‚“</rt></ruby>: <span id="lastSaved"><ruby>æœª<rt>ã¿</rt></ruby><ruby>ä¿<rt>ã»</rt></ruby><ruby>å­˜<rt>ãã‚“</rt></ruby></span>
            </div>
        </div>
    </div>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-content">
            <div class="preview-header">
                <h3>ğŸ–¨ï¸ å°åˆ·(ã„ã‚“ã•ã¤)ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <button class="preview-close" onclick="closePrintPreview()">Ã—</button>
            </div>
            <div class="preview-body">
                <div id="previewPage" class="preview-page">
                    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
            <div class="preview-buttons">
                <button class="preview-btn secondary" onclick="printFromPreview()">
                    ğŸ–¨ï¸ ã“ã®å†…å®¹(ãªã„ã‚ˆã†)ã§å°åˆ·(ã„ã‚“ã•ã¤)
                </button>
                <button class="preview-btn" onclick="closePrintPreview()">
                    âœï¸ ç·¨é›†(ã¸ã‚“ã—ã‚…ã†)ã«æˆ»(ã‚‚ã©)ã‚‹
                </button>
            </div>
        </div>
    </div>

    <script>
        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
        const today = new Date().toLocaleDateString('ja-JP');
        document.getElementById('editor').setAttribute('data-date', today);
        
        // ã‚¨ãƒ‡ã‚£ã‚¿å‚ç…§
        const editor = document.getElementById('editor');
        const charCount = document.getElementById('charCount');
        const lastSaved = document.getElementById('lastSaved');
        
        // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
        function updateCharCount() {
            const text = editor.textContent || editor.innerText || '';
            charCount.textContent = text.length;
            
            // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼åˆ¶å¾¡
            if (text.trim() === '') {
                editor.classList.add('empty');
            } else {
                editor.classList.remove('empty');
            }
        }
        
        // æ›´æ–°æ™‚é–“æ›´æ–°
        function updateLastSaved() {
            const now = new Date();
            lastSaved.textContent = now.toLocaleTimeString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // ã‚¨ãƒ‡ã‚£ã‚¿ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å‰Šé™¤ï¼‰
        editor.addEventListener('click', () => {
            if (editor.classList.contains('empty')) {
                editor.classList.remove('empty');
                editor.innerHTML = '';
                editor.focus();
            }
        });
        
        // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®å‡¦ç†
        editor.addEventListener('focus', () => {
            if (editor.classList.contains('empty')) {
                editor.classList.remove('empty');
                editor.innerHTML = '';
            }
        });
        
        // ã‚¨ãƒ‡ã‚£ã‚¿ã®å¤‰æ›´ã‚’ç›£è¦–
        editor.addEventListener('input', () => {
            updateCharCount();
            updateLastSaved();
        });
        
        // ã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸæ™‚
        editor.addEventListener('blur', () => {
            const text = editor.textContent || editor.innerText || '';
            if (text.trim() === '') {
                editor.classList.add('empty');
                editor.innerHTML = '';
            }
        });
        
        // ãƒšãƒ¼ã‚¹ãƒˆæ™‚ã®å‡¦ç†ï¼ˆHTMLæ¸…æµ„åŒ–ï¼‰
        editor.addEventListener('paste', (e) => {
            // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤
            if (editor.classList.contains('empty')) {
                editor.classList.remove('empty');
                editor.innerHTML = '';
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è²¼ã‚Šä»˜ã‘ã‚’é˜²ã
            e.preventDefault();
            
            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
            const clipboardData = e.clipboardData || window.clipboardData;
            let htmlData = clipboardData.getData('text/html');
            const textData = clipboardData.getData('text/plain');
            
            let cleanedContent = '';
            
            if (htmlData) {
                // HTMLãƒ‡ãƒ¼ã‚¿ã®æ¸…æµ„åŒ–
                cleanedContent = cleanHTML(htmlData);
            } else if (textData) {
                // ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆ
                cleanedContent = '<p>' + textData.replace(/\n\n+/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';
            }
            
            if (cleanedContent) {
                // ç¾åœ¨ã®ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«æŒ¿å…¥
                document.execCommand('insertHTML', false, cleanedContent);
                
                setTimeout(() => {
                    updateCharCount();
                    updateLastSaved();
                }, 10);
            }
        });
        
        // HTMLæ¸…æµ„åŒ–é–¢æ•°ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ç‰ˆï¼‰
        function cleanHTML(html) {
            // ä¸€æ™‚çš„ãªdivã§å‡¦ç†
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // å±é™ºãªã‚¿ã‚°ã‚’é™¤å»
            ['script', 'iframe', 'style', 'object', 'embed', 'form', 'input', 'button'].forEach(tag => {
                tempDiv.querySelectorAll(tag).forEach(el => el.remove());
            });
            
            // ä¸è¦ãªã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            const elementsWithClass = tempDiv.querySelectorAll('[class]');
            elementsWithClass.forEach(element => {
                // ãƒ«ãƒ“ä»¥å¤–ã®ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                if (element.tagName.toLowerCase() !== 'ruby' && element.tagName.toLowerCase() !== 'rt') {
                    element.removeAttribute('class');
                }
            });
            
            // ä¸è¦ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‰Šé™¤
            const elementsWithStyle = tempDiv.querySelectorAll('[style]');
            elementsWithStyle.forEach(element => {
                element.removeAttribute('style');
            });
            
            // å±é™ºãªå±æ€§ã‚’å‰Šé™¤
            const allElements = tempDiv.querySelectorAll('*');
            allElements.forEach(element => {
                ['onclick', 'onload', 'onerror', 'onmouseover', 'onfocus'].forEach(attr => {
                    element.removeAttribute(attr);
                });
            });
            
            // æ®µè½é–¢é€£ã®divã‚’pã‚¿ã‚°ã«å¤‰æ›
            const paragraphDivs = tempDiv.querySelectorAll('div.paragraph-content, .paragraph-content');
            paragraphDivs.forEach(div => {
                const p = document.createElement('p');
                p.innerHTML = div.innerHTML;
                div.parentNode.replaceChild(p, div);
            });
            
            // æ®µè½åŒºåˆ‡ã‚Šdivã‚’å‰Šé™¤
            const breakDivs = tempDiv.querySelectorAll('div.paragraph-break, .paragraph-break');
            breakDivs.forEach(div => {
                div.remove();
            });
            
            // æ®‹ã£ãŸç„¡æ„å‘³ãªdivã‚’pã‚¿ã‚°ã«å¤‰æ›
            const divs = tempDiv.querySelectorAll('div');
            divs.forEach(div => {
                if (div.innerHTML.trim()) {
                    const p = document.createElement('p');
                    p.innerHTML = div.innerHTML;
                    div.parentNode.replaceChild(p, div);
                } else {
                    div.remove();
                }
            });
            
            // ç©ºã®è¦ç´ ã‚’å‰Šé™¤
            const emptyElements = tempDiv.querySelectorAll('p:empty, br + br');
            emptyElements.forEach(element => element.remove());
            
            return tempDiv.innerHTML;
        }
        
        // åˆæœŸæ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
        updateCharCount();
        
        // é€šçŸ¥è¡¨ç¤º
        function showNotification(message, isError = false) {
            // æ—¢å­˜ã®é€šçŸ¥ã‚’å‰Šé™¤
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${isError ? 'error' : ''}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
            setTimeout(() => notification.classList.add('show'), 100);
            
            // è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æ©Ÿèƒ½
        function loadDocument() {
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠç”¨inputè¦ç´ ã‚’ä½œæˆ
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.html';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç¢ºèª
                if (!confirm(`ğŸ“ ã€Œ${file.name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\n\nç¾åœ¨ã®å†…å®¹ã¯æ¶ˆå»ã•ã‚Œã¾ã™ã€‚\n\nâœ… OK = èª­ã¿è¾¼ã‚€\nâŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ« = å–ã‚Šæ¶ˆã—`)) {
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const htmlContent = event.target.result;
                        
                        // HTMLã‹ã‚‰bodyéƒ¨åˆ†ã‚’æŠ½å‡º
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = htmlContent;
                        
                        // bodyè¦ç´ ã‚’æ¢ã™
                        let bodyContent = '';
                        const bodyElement = tempDiv.querySelector('body');
                        if (bodyElement) {
                            bodyContent = bodyElement.innerHTML;
                        } else {
                            // bodyã‚¿ã‚°ãŒãªã„å ´åˆã¯å…¨ä½“ã‚’ä½¿ç”¨
                            bodyContent = htmlContent;
                        }
                        
                        // ä¸è¦ãªã‚¿ã‚°ã‚’é™¤å»ï¼ˆå®‰å…¨æ€§ã®ãŸã‚ï¼‰
                        const cleanDiv = document.createElement('div');
                        cleanDiv.innerHTML = bodyContent;
                        
                        // å±é™ºãªã‚¿ã‚°ã‚’é™¤å»
                        ['script', 'style', 'link', 'meta', 'head', 'title'].forEach(tag => {
                            cleanDiv.querySelectorAll(tag).forEach(el => el.remove());
                        });
                        
                        // ã‚¨ãƒ‡ã‚£ã‚¿ã«å†…å®¹ã‚’è¨­å®š
                        editor.innerHTML = cleanDiv.innerHTML;
                        editor.classList.remove('empty');
                        
                        // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨­å®šï¼ˆæ‹¡å¼µå­ã‚’é™¤å»ï¼‰
                        const fileName = file.name.replace(/\.[^/.]+$/, '');
                        document.getElementById('filename').value = fileName;
                        
                        updateCharCount();
                        updateLastSaved();
                        showNotification(`ğŸ“ ã€Œ${file.name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                        
                    } catch (error) {
                        showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
                    }
                };
                
                reader.readAsText(file, 'UTF-8');
            });
            
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }
        
        // æ–°è¦ä½œæˆ
        function newDocument() {
            if (!confirm('ğŸ“ æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\n\nç¾åœ¨ã®å†…å®¹ã¯æ¶ˆå»ã•ã‚Œã¾ã™ã€‚\n\nâœ… OK = æ–°è¦ä½œæˆ\nâŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ« = å–ã‚Šæ¶ˆã—')) return;
            
            editor.innerHTML = '';
            editor.setAttribute('data-date', new Date().toLocaleDateString('ja-JP'));
            editor.classList.add('empty');
            document.getElementById('filename').value = 'å­¦ç¿’è³‡æ–™';
            updateCharCount();
            showNotification('ğŸ“„ æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');
        }
        
        // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¿å­˜
        function saveDocument() {
            try {
                const filename = document.getElementById('filename').value.trim() || 'å­¦ç¿’è³‡æ–™';
                let content = editor.innerHTML;
                
                // ç©ºã®å ´åˆã®å‡¦ç†
                if (editor.classList.contains('empty') || !content.trim()) {
                    showNotification('ä¿å­˜ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“', true);
                    return;
                }
                
                // A4å°åˆ·æœ€é©åŒ–HTML
                const html = `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${filename}</title>
    <style>
        body {
            font-family: 'BIZ UDPã‚´ã‚·ãƒƒã‚¯', 'Yu Gothic UI', 'Meiryo UI', 'Hiragino Sans', sans-serif;
            font-size: 14px;
            line-height: 2.0;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            color: #333;
        }
        ruby {
            ruby-align: start;
            ruby-position: over;
        }
        ruby rt {
            font-size: 7px;
            color: #666;
            font-weight: normal;
        }
        p {
            margin-bottom: 1em;
        }
        h1, h2, h3 {
            margin-bottom: 0.8em;
            color: #444;
        }
        
        /* A4å°åˆ·æœ€é©åŒ– */
        @media print {
            body {
                font-size: 11pt;
                line-height: 1.8;
                padding: 20mm 15mm;
                max-width: none;
            }
            ruby rt {
                font-size: 5.5pt;
            }
            p {
                margin-bottom: 0.8em;
                page-break-inside: avoid;
                orphans: 2;
                widows: 2;
            }
            @page {
                size: A4;
                margin: 20mm 15mm;
            }
        }
    </style>
</head>
<body>
${content}
</body>
</html>`;
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename + '.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`ğŸ’¾ ${filename}.html ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
                updateLastSaved();
                
            } catch (error) {
                showNotification('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            }
        }
        
        // å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        function showPrintPreview() {
            let content = editor.innerHTML;
            
            // ç©ºã®å ´åˆã®å‡¦ç†
            if (editor.classList.contains('empty') || !content.trim()) {
                showNotification('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“', true);
                return;
            }
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒšãƒ¼ã‚¸ã«å†…å®¹ã‚’è¨­å®š
            document.getElementById('previewPage').innerHTML = content;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            document.getElementById('previewModal').classList.add('show');
            
            // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹
            document.body.style.overflow = 'hidden';
            
            showNotification('ğŸ‘€ å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‰ã˜ã‚‹
        function closePrintPreview() {
            document.getElementById('previewModal').classList.remove('show');
            document.body.style.overflow = 'auto';
        }
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰å°åˆ·
        function printFromPreview() {
            const filename = document.getElementById('filename').value.trim() || 'å­¦ç¿’è³‡æ–™';
            const content = document.getElementById('previewPage').innerHTML;
            
            try {
                // å°åˆ·ç”¨HTMLä½œæˆ
                const printHTML = `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>${filename}</title>
    <style>
        body {
            font-family: 'BIZ UDPã‚´ã‚·ãƒƒã‚¯', 'Yu Gothic UI', 'Meiryo UI', 'Hiragino Sans', sans-serif;
            font-size: 11pt;
            line-height: 1.8;
            margin: 20mm 15mm;
            background: white;
            color: #333;
        }
        ruby {
            ruby-align: start;
            ruby-position: over;
        }
        ruby rt {
            font-size: 5.5pt;
            color: #666;
            font-weight: normal;
        }
        p {
            margin-bottom: 0.8em;
            page-break-inside: avoid;
            orphans: 2;
            widows: 2;
        }
        @page {
            size: A4;
            margin: 20mm 15mm;
        }
        @media print {
            body { margin: 0; }
        }
    </style>
</head>
<body>${content}</body>
</html>`;
                
                // Blobä½œæˆã—ã¦ãƒ—ãƒªãƒ³ãƒˆ
                const blob = new Blob([printHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                
                // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã„ã¦å°åˆ·
                const printWindow = window.open(url, '_blank', 'width=800,height=600');
                
                if (printWindow) {
                    printWindow.onload = function() {
                        setTimeout(() => {
                            printWindow.print();
                            closePrintPreview();
                            showNotification('ğŸ–¨ï¸ å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãã¾ã—ãŸ');
                        }, 1000);
                    };
                } else {
                    showNotification('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ', true);
                }
                
                setTimeout(() => URL.revokeObjectURL(url), 5000);
                
            } catch (error) {
                showNotification('å°åˆ·ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', true);
            }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('previewModal').addEventListener('click', (e) => {
            if (e.target.id === 'previewModal') {
                closePrintPreview();
            }
        });
        
        // ESCã‚­ãƒ¼ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‰ã˜ã‚‹
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePrintPreview();
            }
        });
        
        // å°åˆ·æ©Ÿèƒ½
        function printDocument() {
            const filename = document.getElementById('filename').value.trim() || 'å­¦ç¿’è³‡æ–™';
            let content = editor.innerHTML;
            
            // ç©ºã®å ´åˆã®å‡¦ç†
            if (editor.classList.contains('empty') || !content.trim()) {
                showNotification('å°åˆ·ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“', true);
                return;
            }
            
            // A4å°åˆ·ç”¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã
            const printWindow = window.open('', 'printWindow', 'width=800,height=600');
            
            printWindow.document.write(`
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>${filename}</title>
    <style>
        body {
            font-family: 'BIZ UDPã‚´ã‚·ãƒƒã‚¯', 'Yu Gothic UI', 'Meiryo UI', 'Hiragino Sans', sans-serif;
            font-size: 11pt;
            line-height: 1.8;
            margin: 20mm 15mm;
            background: white;
            color: #333;
        }
        ruby {
            ruby-align: start;
            ruby-position: over;
        }
        ruby rt {
            font-size: 5.5pt;
            color: #666;
            font-weight: normal;
        }
        p {
            margin-bottom: 0.8em;
            page-break-inside: avoid;
            orphans: 2;
            widows: 2;
        }
        h1, h2, h3 {
            margin-bottom: 0.8em;
            color: #444;
            page-break-after: avoid;
        }
        
        @page {
            size: A4;
            margin: 20mm 15mm;
        }
        
        @media print {
            body {
                margin: 0;
            }
        }
    </style>
</head>
<body>
${content}
</body>
</html>
            `);
            
            printWindow.document.close();
            
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
            setTimeout(() => {
                printWindow.print();
                showNotification('ğŸ–¨ï¸ A4å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹ãã¾ã—ãŸ');
            }, 500);
        }
        
        // ã‚¯ãƒªã‚¢æ©Ÿèƒ½
        function clearDocument() {
            if (!confirm('ğŸ“ æ›¸ã„ãŸå†…å®¹ã‚’å…¨ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ\n\nâœ… OK = æ¶ˆå»ã™ã‚‹\nâŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ« = æ¶ˆå»ã—ãªã„')) return;
            
            editor.innerHTML = '';
            editor.setAttribute('data-date', new Date().toLocaleDateString('ja-JP'));
            editor.classList.add('empty');
            updateCharCount();
            showNotification('ğŸ—‘ï¸ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¶ˆå»ã—ã¾ã—ãŸ');
            setTimeout(() => editor.focus(), 100);
        }
        
        // ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ã‚’é–‹ã
        function openHelp() {
            window.open('help.html', 'helpWindow', 'width=900,height=700,scrollbars=yes');
        }
        
        // åˆæœŸåŒ–å‡¦ç†
        window.addEventListener('load', () => {
            // åˆæœŸãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã¯ã—ãªã„ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼è¡¨ç¤ºã®ãŸã‚ï¼‰
        });
        
        // Ctrl+S ã§ä¿å­˜
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveDocument();
            }
        });
    </script>
</body>
</html>