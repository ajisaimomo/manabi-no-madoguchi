<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÑ Â≠¶Áøí„Éâ„Ç≠„É•„É°„É≥„Éà‰ΩúÊàê</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'BIZ UDP„Ç¥„Ç∑„ÉÉ„ÇØ', 'Yu Gothic UI', 'Meiryo UI', 'Hiragino Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            min-height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .toolbar {
            background: #f8f9ff;
            padding: 15px 20px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            min-height: 40px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #48bb78, #38a169);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #fc8181, #f56565);
        }
        
        .filename-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        
        .filename-input {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            width: 200px;
        }
        
        .editor-container {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .editor {
            flex: 1;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            font-size: 16px;
            line-height: 2.2;
            min-height: 500px;
            outline: none;
            transition: border-color 0.3s ease;
            overflow-y: auto;
            position: relative;
        }
        
        .editor:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .editor p {
            margin-bottom: 1em;
        }
        
        .editor ruby {
            ruby-align: start;
            ruby-position: over;
        }
        
        .editor ruby rt {
            font-size: 8px;
            color: #666;
            font-weight: normal;
        }
        
        /* „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Çπ„Çø„Ç§„É´ */
        .editor.empty::before {
            content: "üìö Â≠¶Áøí(„Åå„Åè„Åó„ÇÖ„ÅÜ)„Éâ„Ç≠„É•„É°„É≥„Éà\A\A‰ΩúÊàêÊó•(„Åï„Åè„Åõ„ÅÑ„Å≥): " attr(data-date) "\A\A„Åì„Åì„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÊñáÁ´†(„Å∂„Çì„Åó„Çá„ÅÜ)„ÇíÊõ∏(„Åã)„Åì„ÅÜÔºÅ\A\Aüí° „Åã„Çì„Åü„Çì„Å™‰Ωø(„Å§„Åã)„ÅÑÊñπ(„Åã„Åü):\A‚ë† Ë™ø(„Åó„Çâ)„Åπ„ÇãÁ™ìÂè£(„Åæ„Å©„Åê„Å°)„Åß„Ç≥„Éî„Éº\A‚ë° „Åì„Åì„Å´Ë≤º(„ÅØ)„Çä‰ªò(„Å§)„Åë\A‚ë¢ ‰øùÂ≠ò(„Åª„Åû„Çì)„ÉªÂç∞Âà∑(„ÅÑ„Çì„Åï„Å§)";
            white-space: pre-line;
            color: #999;
            font-style: italic;
            pointer-events: none;
            position: absolute;
            top: 20px;
            left: 20px;
            line-height: 2.2;
            font-size: 15px;
        }
        
        .status-bar {
            background: #f8f9ff;
            padding: 10px 20px;
            border-top: 1px solid #e2e8f0;
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .word-count {
            font-weight: 600;
        }
        
        .a4-info {
            font-size: 11px;
            color: #888;
            display: flex;
            gap: 15px;
        }
        
        .last-saved {
            font-style: italic;
        }
        
        /* A4Âç∞Âà∑ÊúÄÈÅ©Âåñ */
        @media print {
            body {
                background: white;
                padding: 0;
                font-size: 11pt;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
                min-height: auto;
                max-width: none;
            }
            
            .header, .toolbar, .status-bar {
                display: none;
            }
            
            .editor-container {
                padding: 0;
            }
            
            .editor {
                border: none;
                box-shadow: none;
                min-height: auto;
                font-size: 11pt;
                line-height: 1.8;
                padding: 20mm 15mm;
                page-break-inside: avoid;
            }
            
            .editor ruby rt {
                font-size: 5.5pt;
            }
            
            .editor p {
                margin-bottom: 0.8em;
                page-break-inside: avoid;
                orphans: 2;
                widows: 2;
            }
            
            @page {
                size: A4;
                margin: 20mm 15mm;
            }
        }
        
        /* „É¢„Éê„Ç§„É´ÂØæÂøú */
        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filename-group {
                margin-left: 0;
                justify-content: stretch;
            }
            
            .filename-input {
                width: 100%;
            }
            
            .btn {
                justify-content: center;
                width: 100%;
            }
            
            .a4-info {
                flex-direction: column;
                gap: 5px;
            }
        }
        
        /* ÈÄöÁü•„Çπ„Çø„Ç§„É´ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #48bb78;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #f56565;
        }
        
        /* „Éó„É¨„Éì„É•„Éº„É¢„Éº„ÉÄ„É´ */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .preview-modal.show {
            display: flex;
        }
        
        .preview-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            height: 90%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .preview-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-header h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .preview-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-close:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .preview-body {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        
        .preview-page {
            width: 210mm;
            min-height: 297mm;
            margin: 20px auto;
            padding: 20mm 15mm;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            background: white;
            font-family: 'BIZ UDP„Ç¥„Ç∑„ÉÉ„ÇØ', 'Yu Gothic UI', 'Meiryo UI', 'Hiragino Sans', sans-serif;
            font-size: 11pt;
            line-height: 1.8;
            color: #333;
            box-sizing: border-box;
            transform: scale(0.6);
            transform-origin: top center;
        }
        
        .preview-page ruby {
            ruby-align: start;
            ruby-position: over;
        }
        
        .preview-page ruby rt {
            font-size: 5.5pt;
            color: #666;
            font-weight: normal;
        }
        
        .preview-page p {
            margin-bottom: 0.8em;
        }
        
        .preview-buttons {
            padding: 15px 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .preview-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .preview-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .preview-btn.secondary {
            background: linear-gradient(45deg, #48bb78, #38a169);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÑ <ruby>Â≠¶<rt>„Åå„Åè</rt></ruby><ruby>Áøí<rt>„Åó„ÇÖ„ÅÜ</rt></ruby>„Éâ„Ç≠„É•„É°„É≥„Éà<ruby>‰Ωú<rt>„Åï„Åè</rt></ruby><ruby>Êàê<rt>„Åõ„ÅÑ</rt></ruby></h1>
            <p><ruby>Ë™ø<rt>„Åó„Çâ</rt></ruby>„Åπ„Åü<ruby>ÂÜÖ<rt>„Å™„ÅÑ</rt></ruby><ruby>ÂÆπ<rt>„Çà„ÅÜ</rt></ruby>„Çí„Åæ„Å®„ÇÅ„Å¶„ÄÅ<ruby>‰øù<rt>„Åª</rt></ruby><ruby>Â≠ò<rt>„Åû„Çì</rt></ruby>„Éª<ruby>Âç∞<rt>„ÅÑ„Çì</rt></ruby><ruby>Âà∑<rt>„Åï„Å§</rt></ruby>„Åó„Çà„ÅÜ</p>
        </div>
        
        <div class="toolbar">
            <button class="btn" onclick="newDocument()">
                üìÑ <ruby>Êñ∞<rt>„Åó„Çì</rt></ruby><ruby>Ë¶è<rt>„Åç</rt></ruby><ruby>‰Ωú<rt>„Åï„Åè</rt></ruby><ruby>Êàê<rt>„Åõ„ÅÑ</rt></ruby>
            </button>
            <button class="btn btn-secondary" onclick="loadDocument()">
                üìÅ „Éï„Ç°„Ç§„É´<ruby>Ë™≠<rt>„Çà</rt></ruby>„Åø<ruby>Ëæº<rt>„Åì</rt></ruby>„Åø
            </button>
            <button class="btn btn-secondary" onclick="saveDocument()">
                üíæ <ruby>‰øù<rt>„Åª</rt></ruby><ruby>Â≠ò<rt>„Åû„Çì</rt></ruby>
            </button>
            <button class="btn" onclick="printDocument()">
                üñ®Ô∏è <ruby>Âç∞<rt>„ÅÑ„Çì</rt></ruby><ruby>Âà∑<rt>„Åï„Å§</rt></ruby>
            </button>
            <button class="btn" onclick="showPrintPreview()">
                üëÄ „Éó„É¨„Éì„É•„Éº
            </button>
            <button class="btn btn-danger" onclick="clearDocument()">
                üóëÔ∏è <ruby>Ê∂à<rt>„Åó„Çá„ÅÜ</rt></ruby><ruby>Âéª<rt>„Åç„Çá</rt></ruby>
            </button>
            <button class="btn" onclick="openHelp()">
                ‚ùì <ruby>‰Ωø<rt>„Å§„Åã</rt></ruby>„ÅÑ<ruby>Êñπ<rt>„Åã„Åü</rt></ruby>
            </button>
            
            <div class="filename-group">
                <label for="filename">„Éï„Ç°„Ç§„É´<ruby>Âêç<rt>„ÇÅ„ÅÑ</rt></ruby>:</label>
                <input type="text" id="filename" class="filename-input" value="Â≠¶ÁøíË≥áÊñô" placeholder="„Éï„Ç°„Ç§„É´Âêç„ÇíÂÖ•Âäõ">
                <span>.html</span>
            </div>
        </div>
        
        <div class="editor-container">
            <div id="editor" class="editor empty" contenteditable="true" data-date=""></div>
        </div>
        
        <div class="status-bar">
            <div class="word-count">
                <ruby>Êñá<rt>„ÇÇ„Åò</rt></ruby><ruby>Â≠ó<rt>„Åò</rt></ruby><ruby>Êï∞<rt>„Åô„ÅÜ</rt></ruby>: <span id="charCount">0</span><ruby>Êñá<rt>„ÇÇ</rt></ruby><ruby>Â≠ó<rt>„Åò</rt></ruby>
            </div>
            <div class="a4-info">
                <span>üìÑ A4<ruby>Áî®<rt>„Çà„ÅÜ</rt></ruby><ruby>Á¥ô<rt>„Åó</rt></ruby><ruby>ÊúÄ<rt>„Åï„ÅÑ</rt></ruby><ruby>ÈÅ©<rt>„Å¶„Åç</rt></ruby><ruby>Âåñ<rt>„Åã</rt></ruby>Ê∏à„Åø</span>
                <span>üìè <ruby>ÁõÆ<rt>„ÇÅ</rt></ruby><ruby>ÂÆâ<rt>„ÇÑ„Åô</rt></ruby>: 1,000-1,500<ruby>Êñá<rt>„ÇÇ</rt></ruby><ruby>Â≠ó<rt>„Åò</rt></ruby>/„Éö„Éº„Ç∏</span>
            </div>
            <div class="last-saved">
                <ruby>ÊúÄ<rt>„Åï„ÅÑ</rt></ruby><ruby>ÁµÇ<rt>„Åó„ÇÖ„ÅÜ</rt></ruby><ruby>Êõ¥<rt>„Åì„ÅÜ</rt></ruby><ruby>Êñ∞<rt>„Åó„Çì</rt></ruby>: <span id="lastSaved"><ruby>Êú™<rt>„Åø</rt></ruby><ruby>‰øù<rt>„Åª</rt></ruby><ruby>Â≠ò<rt>„Åû„Çì</rt></ruby></span>
            </div>
        </div>
    </div>

    <!-- „Éó„É¨„Éì„É•„Éº„É¢„Éº„ÉÄ„É´ -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-content">
            <div class="preview-header">
                <h3>üñ®Ô∏è Âç∞Âà∑(„ÅÑ„Çì„Åï„Å§)„Éó„É¨„Éì„É•„Éº</h3>
                <button class="preview-close" onclick="closePrintPreview()">√ó</button>
            </div>
            <div class="preview-body">
                <div id="previewPage" class="preview-page">
                    <!-- „Éó„É¨„Éì„É•„ÉºÂÜÖÂÆπ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                </div>
            </div>
            <div class="preview-buttons">
                <button class="preview-btn secondary" onclick="printFromPreview()">
                    üñ®Ô∏è „Åì„ÅÆÂÜÖÂÆπ(„Å™„ÅÑ„Çà„ÅÜ)„ÅßÂç∞Âà∑(„ÅÑ„Çì„Åï„Å§)
                </button>
                <button class="preview-btn" onclick="closePrintPreview()">
                    ‚úèÔ∏è Á∑®ÈõÜ(„Å∏„Çì„Åó„ÇÖ„ÅÜ)„Å´Êàª(„ÇÇ„Å©)„Çã
                </button>
            </div>
        </div>
    </div>

    <script>
        // ‰ªäÊó•„ÅÆÊó•‰ªò„ÇíË®≠ÂÆö
        const today = new Date().toLocaleDateString('ja-JP');
        document.getElementById('editor').setAttribute('data-date', today);
        
        // „Ç®„Éá„Ç£„ÇøÂèÇÁÖß
        const editor = document.getElementById('editor');
        const charCount = document.getElementById('charCount');
        const lastSaved = document.getElementById('lastSaved');
        
        // ÊñáÂ≠óÊï∞„Ç´„Ç¶„É≥„ÉàÊõ¥Êñ∞
        function updateCharCount() {
            const text = editor.textContent || editor.innerText || '';
            charCount.textContent = text.length;
            
            // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÂà∂Âæ°
            if (text.trim() === '') {
                editor.classList.add('empty');
            } else {
                editor.classList.remove('empty');
            }
        }
        
        // Êõ¥Êñ∞ÊôÇÈñìÊõ¥Êñ∞
        function updateLastSaved() {
            const now = new Date();
            lastSaved.textContent = now.toLocaleTimeString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // „Ç®„Éá„Ç£„Çø„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆÂá¶ÁêÜÔºà„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÂâäÈô§Ôºâ
        editor.addEventListener('click', () => {
            if (editor.classList.contains('empty')) {
                editor.classList.remove('empty');
                editor.innerHTML = '';
                editor.focus();
            }
        });
        
        // „Ç®„Éá„Ç£„Çø„Éï„Ç©„Éº„Ç´„ÇπÊôÇ„ÅÆÂá¶ÁêÜ
        editor.addEventListener('focus', () => {
            if (editor.classList.contains('empty')) {
                editor.classList.remove('empty');
                editor.innerHTML = '';
            }
        });
        
        // „Ç®„Éá„Ç£„Çø„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
        editor.addEventListener('input', () => {
            updateCharCount();
            updateLastSaved();
        });
        
        // „Ç®„Éá„Ç£„Çø„Åã„Çâ„Éï„Ç©„Éº„Ç´„Çπ„ÅåÂ§ñ„Çå„ÅüÊôÇ
        editor.addEventListener('blur', () => {
            const text = editor.textContent || editor.innerText || '';
            if (text.trim() === '') {
                editor.classList.add('empty');
                editor.innerHTML = '';
            }
        });
        
        // „Éö„Éº„Çπ„ÉàÊôÇ„ÅÆÂá¶ÁêÜÔºàHTMLÊ∏ÖÊµÑÂåñÔºâ
        editor.addEventListener('paste', (e) => {
            // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂâäÈô§
            if (editor.classList.contains('empty')) {
                editor.classList.remove('empty');
                editor.innerHTML = '';
            }
            
            // „Éá„Éï„Ç©„É´„Éà„ÅÆË≤º„Çä‰ªò„Åë„ÇíÈò≤„Åê
            e.preventDefault();
            
            // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Åã„Çâ„Éá„Éº„ÇøÂèñÂæó
            const clipboardData = e.clipboardData || window.clipboardData;
            let htmlData = clipboardData.getData('text/html');
            const textData = clipboardData.getData('text/plain');
            
            let cleanedContent = '';
            
            if (htmlData) {
                // HTML„Éá„Éº„Çø„ÅÆÊ∏ÖÊµÑÂåñ
                cleanedContent = cleanHTML(htmlData);
            } else if (textData) {
                // „Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„Éà„ÅÆÂ†¥Âêà
                cleanedContent = '<p>' + textData.replace(/\n\n+/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';
            }
            
            if (cleanedContent) {
                // ÁèæÂú®„ÅÆ„Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„Å´ÊåøÂÖ•
                document.execCommand('insertHTML', false, cleanedContent);
                
                setTimeout(() => {
                    updateCharCount();
                    updateLastSaved();
                }, 10);
            }
        });
        
        // HTMLÊ∏ÖÊµÑÂåñÈñ¢Êï∞Ôºà„Çª„Ç≠„É•„É™„ÉÜ„Ç£Âº∑ÂåñÁâàÔºâ
        function cleanHTML(html) {
            // ‰∏ÄÊôÇÁöÑ„Å™div„ÅßÂá¶ÁêÜ
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Âç±Èô∫„Å™„Çø„Ç∞„ÇíÈô§Âéª
            ['script', 'iframe', 'style', 'object', 'embed', 'form', 'input', 'button'].forEach(tag => {
                tempDiv.querySelectorAll(tag).forEach(el => el.remove());
            });
            
            // ‰∏çË¶Å„Å™„ÇØ„É©„Çπ„ÇíÂâäÈô§
            const elementsWithClass = tempDiv.querySelectorAll('[class]');
            elementsWithClass.forEach(element => {
                // „É´„Éì‰ª•Â§ñ„ÅÆ„ÇØ„É©„Çπ„ÇíÂâäÈô§
                if (element.tagName.toLowerCase() !== 'ruby' && element.tagName.toLowerCase() !== 'rt') {
                    element.removeAttribute('class');
                }
            });
            
            // ‰∏çË¶Å„Å™„Çπ„Çø„Ç§„É´„ÇíÂâäÈô§
            const elementsWithStyle = tempDiv.querySelectorAll('[style]');
            elementsWithStyle.forEach(element => {
                element.removeAttribute('style');
            });
            
            // Âç±Èô∫„Å™Â±ûÊÄß„ÇíÂâäÈô§
            const allElements = tempDiv.querySelectorAll('*');
            allElements.forEach(element => {
                ['onclick', 'onload', 'onerror', 'onmouseover', 'onfocus'].forEach(attr => {
                    element.removeAttribute(attr);
                });
            });
            
            // ÊÆµËêΩÈñ¢ÈÄ£„ÅÆdiv„Çíp„Çø„Ç∞„Å´Â§âÊèõ
            const paragraphDivs = tempDiv.querySelectorAll('div.paragraph-content, .paragraph-content');
            paragraphDivs.forEach(div => {
                const p = document.createElement('p');
                p.innerHTML = div.innerHTML;
                div.parentNode.replaceChild(p, div);
            });
            
            // ÊÆµËêΩÂå∫Âàá„Çädiv„ÇíÂâäÈô§
            const breakDivs = tempDiv.querySelectorAll('div.paragraph-break, .paragraph-break');
            breakDivs.forEach(div => {
                div.remove();
            });
            
            // ÊÆã„Å£„ÅüÁÑ°ÊÑèÂë≥„Å™div„Çíp„Çø„Ç∞„Å´Â§âÊèõ
            const divs = tempDiv.querySelectorAll('div');
            divs.forEach(div => {
                if (div.innerHTML.trim()) {
                    const p = document.createElement('p');
                    p.innerHTML = div.innerHTML;
                    div.parentNode.replaceChild(p, div);
                } else {
                    div.remove();
                }
            });
            
            // Á©∫„ÅÆË¶ÅÁ¥†„ÇíÂâäÈô§
            const emptyElements = tempDiv.querySelectorAll('p:empty, br + br');
            emptyElements.forEach(element => element.remove());
            
            return tempDiv.innerHTML;
        }
        
        // ÂàùÊúüÊñáÂ≠óÊï∞„Ç´„Ç¶„É≥„Éà
        updateCharCount();
        
        // ÈÄöÁü•Ë°®Á§∫
        function showNotification(message, isError = false) {
            // Êó¢Â≠ò„ÅÆÈÄöÁü•„ÇíÂâäÈô§
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${isError ? 'error' : ''}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë°®Á§∫
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Ëá™ÂãïÂâäÈô§
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // „Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÊ©üËÉΩ
        function loadDocument() {
            // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÁî®inputË¶ÅÁ¥†„Çí‰ΩúÊàê
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.html';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // „Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÁ¢∫Ë™ç
                if (!confirm(`üìÅ „Äå${file.name}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô„ÅãÔºü\n\nÁèæÂú®„ÅÆÂÜÖÂÆπ„ÅØÊ∂àÂéª„Åï„Çå„Åæ„Åô„ÄÇ\n\n‚úÖ OK = Ë™≠„ÅøËæº„ÇÄ\n‚ùå „Ç≠„É£„É≥„Çª„É´ = Âèñ„ÇäÊ∂à„Åó`)) {
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const htmlContent = event.target.result;
                        
                        // HTML„Åã„ÇâbodyÈÉ®ÂàÜ„ÇíÊäΩÂá∫
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = htmlContent;
                        
                        // bodyË¶ÅÁ¥†„ÇíÊé¢„Åô
                        let bodyContent = '';
                        const bodyElement = tempDiv.querySelector('body');
                        if (bodyElement) {
                            bodyContent = bodyElement.innerHTML;
                        } else {
                            // body„Çø„Ç∞„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂÖ®‰Ωì„Çí‰ΩøÁî®
                            bodyContent = htmlContent;
                        }
                        
                        // ‰∏çË¶Å„Å™„Çø„Ç∞„ÇíÈô§ÂéªÔºàÂÆâÂÖ®ÊÄß„ÅÆ„Åü„ÇÅÔºâ
                        const cleanDiv = document.createElement('div');
                        cleanDiv.innerHTML = bodyContent;
                        
                        // Âç±Èô∫„Å™„Çø„Ç∞„ÇíÈô§Âéª
                        ['script', 'style', 'link', 'meta', 'head', 'title'].forEach(tag => {
                            cleanDiv.querySelectorAll(tag).forEach(el => el.remove());
                        });
                        
                        // „Ç®„Éá„Ç£„Çø„Å´ÂÜÖÂÆπ„ÇíË®≠ÂÆö
                        editor.innerHTML = cleanDiv.innerHTML;
                        editor.classList.remove('empty');
                        
                        // „Éï„Ç°„Ç§„É´Âêç„ÇíË®≠ÂÆöÔºàÊã°ÂºµÂ≠ê„ÇíÈô§ÂéªÔºâ
                        const fileName = file.name.replace(/\.[^/.]+$/, '');
                        document.getElementById('filename').value = fileName;
                        
                        updateCharCount();
                        updateLastSaved();
                        showNotification(`üìÅ „Äå${file.name}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);
                        
                    } catch (error) {
                        showNotification('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', true);
                    }
                };
                
                reader.readAsText(file, 'UTF-8');
            });
            
            // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈñã„Åè
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }
        
        // Êñ∞Ë¶è‰ΩúÊàê
        function newDocument() {
            if (!confirm('üìù Êñ∞Ë¶è„Éâ„Ç≠„É•„É°„É≥„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÅãÔºü\n\nÁèæÂú®„ÅÆÂÜÖÂÆπ„ÅØÊ∂àÂéª„Åï„Çå„Åæ„Åô„ÄÇ\n\n‚úÖ OK = Êñ∞Ë¶è‰ΩúÊàê\n‚ùå „Ç≠„É£„É≥„Çª„É´ = Âèñ„ÇäÊ∂à„Åó')) return;
            
            editor.innerHTML = '';
            editor.setAttribute('data-date', new Date().toLocaleDateString('ja-JP'));
            editor.classList.add('empty');
            document.getElementById('filename').value = 'Â≠¶ÁøíË≥áÊñô';
            updateCharCount();
            showNotification('üìÑ Êñ∞Ë¶è„Éâ„Ç≠„É•„É°„É≥„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü');
        }
        
        // „Éâ„Ç≠„É•„É°„É≥„Éà‰øùÂ≠ò
        function saveDocument() {
            try {
                const filename = document.getElementById('filename').value.trim() || 'Â≠¶ÁøíË≥áÊñô';
                let content = editor.innerHTML;
                
                // Á©∫„ÅÆÂ†¥Âêà„ÅÆÂá¶ÁêÜ
                if (editor.classList.contains('empty') || !content.trim()) {
                    showNotification('‰øùÂ≠ò„Åô„ÇãÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', true);
                    return;
                }
                
                // A4Âç∞Âà∑ÊúÄÈÅ©ÂåñHTML
                const html = `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${filename}</title>
    <style>
        body {
            font-family: 'BIZ UDP„Ç¥„Ç∑„ÉÉ„ÇØ', 'Yu Gothic UI', 'Meiryo UI', 'Hiragino Sans', sans-serif;
            font-size: 14px;
            line-height: 2.0;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            color: #333;
        }
        ruby {
            ruby-align: start;
            ruby-position: over;
        }
        ruby rt {
            font-size: 7px;
            color: #666;
            font-weight: normal;
        }
        p {
            margin-bottom: 1em;
        }
        h1, h2, h3 {
            margin-bottom: 0.8em;
            color: #444;
        }
        
        /* A4Âç∞Âà∑ÊúÄÈÅ©Âåñ */
        @media print {
            body {
                font-size: 11pt;
                line-height: 1.8;
                padding: 20mm 15mm;
                max-width: none;
            }
            ruby rt {
                font-size: 5.5pt;
            }
            p {
                margin-bottom: 0.8em;
                page-break-inside: avoid;
                orphans: 2;
                widows: 2;
            }
            @page {
                size: A4;
                margin: 20mm 15mm;
            }
        }
    </style>
</head>
<body>
${content}
</body>
</html>`;
                
                // „Éï„Ç°„Ç§„É´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename + '.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`üíæ ${filename}.html „Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`);
                updateLastSaved();
                
            } catch (error) {
                showNotification('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', true);
            }
        }
        
        // Âç∞Âà∑„Éó„É¨„Éì„É•„ÉºË°®Á§∫
        function showPrintPreview() {
            let content = editor.innerHTML;
            
            // Á©∫„ÅÆÂ†¥Âêà„ÅÆÂá¶ÁêÜ
            if (editor.classList.contains('empty') || !content.trim()) {
                showNotification('„Éó„É¨„Éì„É•„Éº„Åô„ÇãÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', true);
                return;
            }
            
            // „Éó„É¨„Éì„É•„Éº„Éö„Éº„Ç∏„Å´ÂÜÖÂÆπ„ÇíË®≠ÂÆö
            document.getElementById('previewPage').innerHTML = content;
            
            // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
            document.getElementById('previewModal').classList.add('show');
            
            // ËÉåÊôØ„Çπ„ÇØ„É≠„Éº„É´ÁÑ°Âäπ
            document.body.style.overflow = 'hidden';
            
            showNotification('üëÄ Âç∞Âà∑„Éó„É¨„Éì„É•„Éº„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü');
        }
        
        // „Éó„É¨„Éì„É•„ÉºÈñâ„Åò„Çã
        function closePrintPreview() {
            document.getElementById('previewModal').classList.remove('show');
            document.body.style.overflow = 'auto';
        }
        
        // „Éó„É¨„Éì„É•„Éº„Åã„ÇâÂç∞Âà∑
        function printFromPreview() {
            const filename = document.getElementById('filename').value.trim() || 'Â≠¶ÁøíË≥áÊñô';
            const content = document.getElementById('previewPage').innerHTML;
            
            try {
                // Âç∞Âà∑Áî®HTML‰ΩúÊàê
                const printHTML = `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>${filename}</title>
    <style>
        body {
            font-family: 'BIZ UDP„Ç¥„Ç∑„ÉÉ„ÇØ', 'Yu Gothic UI', 'Meiryo UI', 'Hiragino Sans', sans-serif;
            font-size: 11pt;
            line-height: 1.8;
            margin: 20mm 15mm;
            background: white;
            color: #333;
        }
        ruby {
            ruby-align: start;
            ruby-position: over;
        }
        ruby rt {
            font-size: 5.5pt;
            color: #666;
            font-weight: normal;
        }
        p {
            margin-bottom: 0.8em;
            page-break-inside: avoid;
            orphans: 2;
            widows: 2;
        }
        @page {
            size: A4;
            margin: 20mm 15mm;
        }
        @media print {
            body { margin: 0; }
        }
    </style>
</head>
<body>${content}</body>
</html>`;
                
                // Blob‰ΩúÊàê„Åó„Å¶„Éó„É™„É≥„Éà
                const blob = new Blob([printHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                
                // Êñ∞„Åó„ÅÑ„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅßÈñã„ÅÑ„Å¶Âç∞Âà∑
                const printWindow = window.open(url, '_blank', 'width=800,height=600');
                
                if (printWindow) {
                    printWindow.onload = function() {
                        setTimeout(() => {
                            printWindow.print();
                            closePrintPreview();
                            showNotification('üñ®Ô∏è Âç∞Âà∑„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈñã„Åç„Åæ„Åó„Åü');
                        }, 1000);
                    };
                } else {
                    showNotification('„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü', true);
                }
                
                setTimeout(() => URL.revokeObjectURL(url), 5000);
                
            } catch (error) {
                showNotification('Âç∞Âà∑„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', true);
            }
        }
        
        // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        document.getElementById('previewModal').addEventListener('click', (e) => {
            if (e.target.id === 'previewModal') {
                closePrintPreview();
            }
        });
        
        // ESC„Ç≠„Éº„Åß„Éó„É¨„Éì„É•„ÉºÈñâ„Åò„Çã
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePrintPreview();
            }
        });
        
        // Âç∞Âà∑Ê©üËÉΩ
        function printDocument() {
            const filename = document.getElementById('filename').value.trim() || 'Â≠¶ÁøíË≥áÊñô';
            let content = editor.innerHTML;
            
            // Á©∫„ÅÆÂ†¥Âêà„ÅÆÂá¶ÁêÜ
            if (editor.classList.contains('empty') || !content.trim()) {
                showNotification('Âç∞Âà∑„Åô„ÇãÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', true);
                return;
            }
            
            // A4Âç∞Âà∑Áî®„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíÈñã„Åè
            const printWindow = window.open('', 'printWindow', 'width=800,height=600');
            
            printWindow.document.write(`
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>${filename}</title>
    <style>
        body {
            font-family: 'BIZ UDP„Ç¥„Ç∑„ÉÉ„ÇØ', 'Yu Gothic UI', 'Meiryo UI', 'Hiragino Sans', sans-serif;
            font-size: 11pt;
            line-height: 1.8;
            margin: 20mm 15mm;
            background: white;
            color: #333;
        }
        ruby {
            ruby-align: start;
            ruby-position: over;
        }
        ruby rt {
            font-size: 5.5pt;
            color: #666;
            font-weight: normal;
        }
        p {
            margin-bottom: 0.8em;
            page-break-inside: avoid;
            orphans: 2;
            widows: 2;
        }
        h1, h2, h3 {
            margin-bottom: 0.8em;
            color: #444;
            page-break-after: avoid;
        }
        
        @page {
            size: A4;
            margin: 20mm 15mm;
        }
        
        @media print {
            body {
                margin: 0;
            }
        }
    </style>
</head>
<body>
${content}
</body>
</html>
            `);
            
            printWindow.document.close();
            
            // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂç∞Âà∑„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
            setTimeout(() => {
                printWindow.print();
                showNotification('üñ®Ô∏è A4Âç∞Âà∑„Éó„É¨„Éì„É•„Éº„ÇíÈñã„Åç„Åæ„Åó„Åü');
            }, 500);
        }
        
        // „ÇØ„É™„Ç¢Ê©üËÉΩ
        function clearDocument() {
            if (!confirm('üìù Êõ∏„ÅÑ„ÅüÂÜÖÂÆπ„ÇíÂÖ®„Å¶Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü\n\n‚úÖ OK = Ê∂àÂéª„Åô„Çã\n‚ùå „Ç≠„É£„É≥„Çª„É´ = Ê∂àÂéª„Åó„Å™„ÅÑ')) return;
            
            editor.innerHTML = '';
            editor.setAttribute('data-date', new Date().toLocaleDateString('ja-JP'));
            editor.classList.add('empty');
            updateCharCount();
            showNotification('üóëÔ∏è „Éâ„Ç≠„É•„É°„É≥„Éà„ÇíÊ∂àÂéª„Åó„Åæ„Åó„Åü');
            setTimeout(() => editor.focus(), 100);
        }
        
        // ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ„ÇíÈñã„Åè
        function openHelp() {
            window.open('help.html', 'helpWindow', 'width=900,height=700,scrollbars=yes');
        }
        
        // ÂàùÊúüÂåñÂá¶ÁêÜ
        window.addEventListener('load', () => {
            // ÂàùÊúü„Éï„Ç©„Éº„Ç´„Çπ„ÅØ„Åó„Å™„ÅÑÔºà„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºË°®Á§∫„ÅÆ„Åü„ÇÅÔºâ
        });
        
        // Ctrl+S „Åß‰øùÂ≠ò
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveDocument();
            }
        });
    </script>
</body>
</html>