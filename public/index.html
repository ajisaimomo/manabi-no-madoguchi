<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📚調べる窓口</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'BIZ UDPゴシック', 'Yu Gothic UI', 'Meiryo UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            line-height: 2.0 !important; /* 文字ずれ対策 */
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            animation: fadeIn 0.8s ease-out;
            line-height: 2.0 !important; /* 文字ずれ対策 */
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ナビゲーションバー */
        .nav-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }
        
        .nav-bar a {
            padding: 12px 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            min-width: 100px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .nav-bar a:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .nav-bar a ruby rt {
            font-size: 0.6em !important;
            color: white !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            line-height: 1.2;
        }
        
        /* スムーススクロール */
        html {
            scroll-behavior: smooth;
        }
        
        /* デスクトップ用テキスト表示設定 */
        .desktop-text {
            display: inline;
        }
        
        .mobile-text {
            display: none;
        }
        
        /* セクションにスクロール余白を追加 */
        .section {
            scroll-margin-top: 20px;
            margin-bottom: 50px;
            padding: 30px;
            border-radius: 15px;
            background: linear-gradient(145deg, #f8f9ff 0%, #e8f4f8 100%);
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            line-height: 2.0 !important; /* 文字ずれ対策 */
        }
        
        .section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #5a67d8;
            font-size: 2.8em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 1.2em;
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 1.5em;
            color: #4a5568;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            line-height: 2.0 !important; /* 文字ずれ対策 */
        }
        
        /* 検索窓・辞書入力窓のレイアウト（復元） */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .input-group input[type="text"] {
            flex: 1;
            min-width: 300px; /* 最小幅確保 */
        }
        
        /* 検索窓・辞書入力窓のサイズ調整 */
        #searchInput, #dictInput {
            padding: 15px 20px;
            font-size: 16px;
            line-height: 1.4 !important;
            border: 2px solid #cbd5e0;
            border-radius: 10px;
            transition: border-color 0.3s ease;
            font-family: inherit;
            height: 60px !important; /* 1行用に戻す */
            min-height: 60px !important;
            max-height: 60px !important;
            resize: none;
        }
        
        #searchInput:focus, #dictInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* ルビ振り用テキストエリア */
        textarea {
            width: 100%;
            padding: 20px;
            font-size: 18px;
            line-height: 1.6 !important;
            border: 2px solid #cbd5e0;
            border-radius: 10px;
            resize: vertical;
            transition: border-color 0.3s ease;
            font-family: inherit;
            min-height: 200px;
            margin-bottom: 15px;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* ボタンサイズ統一（画面幅対応） */
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 8px; /* 左右パディングを減らす */
            font-size: clamp(11px, 2.3vw, 15px); /* フォントサイズを小さく */
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px; /* アイコンとテキストの間隔を狭く */
            white-space: nowrap;
            line-height: 1.6 !important; /* 行間を調整 */
            min-height: 44px;
            width: 100%;
            overflow: hidden; /* はみ出し防止 */
            text-overflow: ellipsis; /* 長すぎる場合は省略 */
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #48bb78, #38a169);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #fc8181, #f56565);
        }
        
        .btn-copy {
            background: linear-gradient(45deg, #ed8936, #dd6b20);
        }
        
        .btn-voice {
            background: linear-gradient(45deg, #9f7aea, #805ad5);
            min-width: 50px;
            justify-content: center;
        }
        
        /* ボタン内ルビの統一スタイル（文字ずれ対策） */
        .btn ruby {
            ruby-align: start;
            ruby-position: over;
            display: inline-ruby; /* 元に戻す！ */
        }
        
        .btn ruby rt {
            font-size: 0.5em !important;
            color: white !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            line-height: 1.0;
            font-weight: 400;
            letter-spacing: 0.3px;
        }
        
        /* 全体のルビ統一設定（文字ずれ解消） */
        ruby {
            ruby-align: start;
            ruby-position: over;
            display: inline-ruby;
        }
        
        ruby rt {
            font-size: 0.5em;
            color: #666;
            line-height: 1.0;
            font-weight: normal;
        }
        
        /* ボタングループ - 横並び優先 */
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        /* Google検索ボタンを検索窓下に配置 */
        .search-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        
        /* 辞書ボタン - 常に2列固定 */
        .dict-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px; /* ギャップを少し狭く */
            width: 100%;
            margin: 0; /* マージンをリセット */
            padding: 0; /* パディングをリセット */
        }
        
        /* ルビ振りボタン - 常に2列固定 */
        .ruby-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px; /* ギャップを少し狭く */
            width: 100%;
            margin: 0; /* マージンをリセット */
            padding: 0; /* パディングをリセット */
        }
        
        /* 3つ目以降のボタンは下の行にセンタリング */
        .ruby-buttons .btn:nth-child(n+3) {
            grid-column: 1 / -1;
            max-width: 300px;
            justify-self: center;
        }
        
        .result-box {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            min-height: 80px;
            font-size: 18px;
            line-height: 2.4 !important;
            display: none;
        }
        
        /* 辞書結果表示サイズ調整 */
        #dictResult {
            max-height: 250px;
            overflow-y: auto;
            font-size: 16px;
            line-height: 1.8 !important;
        }
        
        .result-success {
            border-color: #68d391;
            background: linear-gradient(145deg, #f0fff4 0%, #c6f6d5 100%);
        }
        
        .result-error {
            border-color: #fc8181;
            background: linear-gradient(145deg, #fffafa 0%, #fed7d7 100%);
            color: #c53030;
        }
        
        .result-loading {
            border-color: #b794f6;
            background: linear-gradient(145deg, #faf5ff 0%, #e9d8fd 100%);
            color: #553c9a;
        }
        
        .stats {
            background: #edf2f7;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
        }
        
        .copy-success {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #48bb78;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: copyNotification 4s ease-out;
        }
        
        @keyframes copyNotification {
            0% { opacity: 0; transform: translateX(100px); }
            10% { opacity: 1; transform: translateX(0); }
            90% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(100px); }
        }
        
        /* 🆕 段落保持機能用のスタイル */
        .paragraph-heading {
            font-weight: bold;
            color: #2d3748;
            margin: 1.8em 0 0.8em 0;
            font-size: 1.1em;
            border-left: 4px solid #667eea;
            padding-left: 12px;
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, transparent 100%);
            border-radius: 4px;
        }
        
        .paragraph-content {
            margin-bottom: 1.2em;
            text-indent: 1em;
            line-height: 2.4;
        }
        
        .paragraph-break {
            height: 0.8em;
            margin: 0.4em 0;
        }
        
        /* 段落内のルビスタイル統一 */
        .paragraph-heading ruby,
        .paragraph-content ruby {
            ruby-align: start;
            ruby-position: over;
            display: inline-ruby;
        }
        
        .paragraph-heading ruby rt,
        .paragraph-content ruby rt {
            font-size: 0.5em;
            color: #666;
            line-height: 1.0;
            font-weight: normal;
        }
        
        /* 見出しのルビは少し小さく */
        .paragraph-heading ruby rt {
            font-size: 0.45em;
            color: #555;
        }
        
        /* スマホ対応（完全修正版） */
        @media (max-width: 768px) {
            /* ナビゲーションバーをスマホ対応 */
            .nav-bar {
                flex-direction: column;
                gap: 8px;
                padding: 12px;
                margin-bottom: 20px;
            }
            
            .nav-bar a {
                padding: 16px 12px;
                min-width: unset;
                width: 100%;
                font-size: 16px;
                text-align: center;
            }
            
            .container { 
                padding: 15px; 
                margin: 5px; 
            }
            
            h1 { 
                font-size: 2.0em; 
                margin-bottom: 15px;
            }
            
            .subtitle {
                font-size: 1.0em;
                margin-bottom: 25px;
            }
            
            .section {
                padding: 20px;
                margin-bottom: 30px;
            }
            
            /* テキスト表示切り替え */
            .desktop-text {
                display: none;
            }
            
            .mobile-text {
                display: inline !important;
            }
            
            .section-title {
                font-size: 1.1em;
                margin-bottom: 15px;
                line-height: 1.3;
                flex-wrap: wrap;
            }
            
            /* 検索窓を縦並びに */
            .input-group { 
                flex-direction: column; 
                align-items: stretch;
            }
            
            .input-group input[type="text"] {
                min-width: unset;
                width: 100%;
                margin-bottom: 15px;
                padding: 16px;
                font-size: 14px;
                height: 56px !important; /* スマホも1行用 */
                line-height: 1.3 !important;
            }
            
            textarea {
                padding: 16px;
                font-size: 16px;
                min-height: 120px;
            }
            
            /* ボタンサイズ調整（スマホ用） */
            .btn { 
                padding: 14px 6px; /* さらにパディング削減 */
                font-size: clamp(10px, 2.8vw, 14px); /* スマホ用フォントサイズ */
                min-height: 50px; /* 高さを少し増やす */
                gap: 2px; /* アイコンとテキストの間隔をさらに狭く */
                line-height: 1.4 !important; /* スマホ用行間 */
            }
            
            /* スマホでのボタングリッド調整 */
            .dict-buttons, .ruby-buttons {
                gap: 6px; /* スマホでさらにギャップを狭く */
                margin: 0;
                padding: 0;
            }
            
            .search-buttons {
                width: 100%;
                gap: 6px; /* 検索ボタンも同様に */
            }
            
            .search-buttons .btn {
                flex: 1;
            }
            
            /* 結果表示を調整 */
            .result-box {
                padding: 15px;
                font-size: 16px;
                line-height: 1.8 !important;
            }
            
            #dictResult {
                max-height: 200px;
                font-size: 15px;
            }
            
            /* 🆕 スマホでの段落スタイル調整 */
            .paragraph-heading {
                margin: 1.2em 0 0.6em 0;
                font-size: 1.0em;
                padding-left: 8px;
            }
            
            .paragraph-content {
                margin-bottom: 1.0em;
                text-indent: 0.8em;
                line-height: 2.2;
            }
        }
        
        /* タブレット対応 */
        @media (min-width: 769px) and (max-width: 1024px) {
            .btn {
                padding: 10px 14px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ナビゲーションバー -->
        <div class="nav-bar">
            <a href="#search-section">
                <ruby>🔍<rt></rt></ruby> <ruby>ウェブ<rt></rt></ruby><ruby>検索<rt>けんさく</rt></ruby>
            </a>
            <a href="#dict-section">
                <ruby>📖<rt></rt></ruby> <ruby>辞書<rt>じしょ</rt></ruby>
            </a>
            <a href="#ruby-section">
                <ruby>✨<rt></rt></ruby> <ruby>ル<rt></rt></ruby><ruby>ビ<rt></rt></ruby><ruby>振<rt>ふ</rt></ruby>り
            </a>
            <a href="help.html" target="_blank">
                <ruby>🤔<rt></rt></ruby> <ruby>困<rt>こま</rt></ruby>ったとき
            </a>
        </div>
        
        <h1><ruby>調<rt>しら</rt></ruby>べる<ruby>窓口<rt>まどぐち</rt></ruby> 📚✨</h1>
        <p class="subtitle">ウェブ<ruby>検索<rt>けんさく</rt></ruby> + <ruby>辞書<rt>じしょ</rt></ruby> + ルビ<ruby>振<rt>ふ</rt></ruby>りが1つのサイトで<ruby>完結<rt>かんけつ</rt></ruby></p>
        
        <!-- 1. Google検索セクション -->
        <div class="section" id="search-section">
            <h2 class="section-title">
                <span>🔍</span>
                <span class="desktop-text">ウェブ<ruby>検索<rt>けんさく</rt></ruby>（<ruby>音声<rt>おんせい</rt></ruby><ruby>入力<rt>にゅうりょく</rt></ruby><ruby>対応<rt>たいおう</rt></ruby>）</span>
                <span class="mobile-text" style="display: none;">ウェブ<ruby>検索<rt>けんさく</rt></ruby></span>
            </h2>
            <div class="input-group">
                <input type="text" id="searchInput" placeholder="調(しら)べたいことを入力(にゅうりょく)してください">
            </div>
            <div class="search-buttons">
                <button class="btn btn-voice" onclick="startVoiceSearch()" id="voiceBtn" title="音声入力">
                    <ruby>🎤<rt></rt></ruby> <ruby>音<rt>おん</rt></ruby><ruby>声<rt>せい</rt></ruby><ruby>入<rt>にゅう</rt></ruby><ruby>力<rt>りょく</rt></ruby>
                </button>
                <button class="btn" onclick="googleSearch()">
                    <ruby>🔍<rt></rt></ruby> <ruby>検<rt>けん</rt></ruby><ruby>索<rt>さく</rt></ruby>
                </button>
            </div>
            <p style="font-size: 14px; color: #666; margin-top: 10px;">
                💡 <ruby>検索<rt>けんさく</rt></ruby><ruby>結果<rt>けっか</rt></ruby>は<ruby>新<rt>あたら</rt></ruby>しいタブで<ruby>開<rt>ひら</rt></ruby>きます。<ruby>結果<rt>けっか</rt></ruby>をコピーして<ruby>下<rt>した</rt></ruby>の「ルビ<ruby>振<rt>ふ</rt></ruby>り」で<ruby>使<rt>つか</rt></ruby>えます。
            </p>
        </div>
        
        <!-- 2. 辞書セクション -->
        <div class="section" id="dict-section">
            <h2 class="section-title">
                <span>📖</span>
                <span class="desktop-text"><ruby>単語<rt>たんご</rt></ruby>の<ruby>意味<rt>いみ</rt></ruby><ruby>調<rt>しら</rt></ruby>べ（2つの<ruby>方法<rt>ほうほう</rt></ruby>）</span>
                <span class="mobile-text" style="display: none;"><ruby>単語<rt>たんご</rt></ruby>の<ruby>意味<rt>いみ</rt></ruby><ruby>調<rt>しら</rt></ruby>べ</span>
            </h2>
            <div class="input-group">
                <input type="text" id="dictInput" placeholder="意味(いみ)を知(し)りたい単語(たんご)を入力(にゅうりょく)してください">
            </div>
            <div class="dict-buttons">
                <button class="btn btn-voice" onclick="startVoiceDict()" id="voiceDictBtn" title="音声入力">
                    <ruby>🎤<rt></rt></ruby> <ruby>音<rt>おん</rt></ruby><ruby>声<rt>せい</rt></ruby><ruby>入<rt>にゅう</rt></ruby><ruby>力<rt>りょく</rt></ruby>
                </button>
                <button class="btn" onclick="searchWeblio()">
                    <ruby>📚<rt></rt></ruby> <ruby>W<rt></rt></ruby><ruby>e<rt></rt></ruby><ruby>b<rt></rt></ruby><ruby>l<rt></rt></ruby><ruby>i<rt></rt></ruby><ruby>o<rt></rt></ruby><ruby>辞<rt>じ</rt></ruby><ruby>書<rt>しょ</rt></ruby>
                </button>
                <button class="btn btn-secondary" onclick="searchGakken()">
                    <ruby>🏫<rt></rt></ruby> <ruby>学<rt>がく</rt></ruby><ruby>研<rt>けん</rt></ruby><ruby>辞<rt>じ</rt></ruby><ruby>書<rt>しょ</rt></ruby>
                </button>
                <button class="btn btn-danger" onclick="clearDict()">
                    <ruby>🗑️<rt></rt></ruby> <ruby>消<rt>しょう</rt></ruby><ruby>去<rt>きょ</rt></ruby>
                </button>
            </div>
            <div id="dictResult" class="result-box"></div>
            <p style="font-size: 14px; color: #666; margin-top: 10px;">
                💡 <strong><ruby>Weblio<rt>ウェブリオ</rt></ruby><ruby>辞書<rt>じしょ</rt></ruby></strong>：<ruby>詳<rt>くわ</rt></ruby>しい<ruby>説明<rt>せつめい</rt></ruby>が<ruby>見<rt>み</rt></ruby>つかります（<ruby>新<rt>あたら</rt></ruby>しいタブで<ruby>開<rt>ひら</rt></ruby>きます）<br>
                💡 <strong><ruby>学研<rt>がくけん</rt></ruby><ruby>辞書<rt>じしょ</rt></ruby></strong>：<ruby>子<rt>こ</rt></ruby>ども<ruby>向<rt>む</rt></ruby>けの<ruby>やさしい<rt>やさしい</rt></ruby><ruby>説明<rt>せつめい</rt></ruby>（<ruby>新<rt>あたら</rt></ruby>しいタブで<ruby>開<rt>ひら</rt></ruby>きます）
            </p>
        </div>
        
        <!-- 3. ルビ振りセクション -->
        <div class="section" id="ruby-section">
            <h2 class="section-title">
                <span>✨</span>
                <span class="desktop-text"><ruby>文章<rt>ぶんしょう</rt></ruby>にルビ<ruby>振<rt>ふ</rt></ruby>り（Word<ruby>貼<rt>は</rt></ruby>り<ruby>付<rt>つ</rt></ruby>け<ruby>対応<rt>たいおう</rt></ruby>）</span>
                <span class="mobile-text" style="display: none;">ルビ<ruby>振<rt>ふ</rt></ruby>り</span>
            </h2>
            <textarea id="rubyInput" rows="8" placeholder="ここに文章(ぶんしょう)をコピー&ペーストしてください。検索結果(けんさくけっか)やニュース、教科書(きょうかしょ)、論文(ろんぶん)など何でもOK！最大(さいだい)2000文字(もじ)まで処理(しょり)できます。段落構造(だんらくこうぞう)も自動(じどう)で保持(ほじ)されます。"></textarea>
            <div class="ruby-buttons">
                <button class="btn" onclick="addRuby()" id="rubyBtn">
                    <ruby>✨<rt></rt></ruby> <ruby>ル<rt></rt></ruby><ruby>ビ<rt></rt></ruby><ruby>を<rt></rt></ruby><ruby>つ<rt></rt></ruby><ruby>け<rt></rt></ruby><ruby>る<rt></rt></ruby>
                </button>
                <button class="btn btn-danger" onclick="clearRuby()">
                    <ruby>🗑️<rt></rt></ruby> <ruby>消<rt>しょう</rt></ruby><ruby>去<rt>きょ</rt></ruby>
                </button>
                <button class="btn btn-copy" onclick="copyResult()" id="copyBtn" style="display: none;">
                    <ruby>📋<rt></rt></ruby> <ruby>結<rt>けっ</rt></ruby><ruby>果<rt>か</rt></ruby><ruby>を<rt></rt></ruby><ruby>コ<rt></rt></ruby><ruby>ピ<rt></rt></ruby><ruby>ー<rt></rt></ruby>
                </button>
                <button class="btn btn-secondary" onclick="speakRubyResult()" id="speakBtn" style="display: none;">
                    <ruby>🔊<rt></rt></ruby> <ruby>読<rt>よ</rt></ruby><ruby>み<rt></rt></ruby><ruby>上<rt>あ</rt></ruby><ruby>げ<rt></rt></ruby>
                </button>
                <button class="btn btn-danger" onclick="stopSpeaking()" id="stopBtn" style="display: none;">
                    <ruby>⏹️<rt></rt></ruby> <ruby>停<rt>てい</rt></ruby><ruby>止<rt>し</rt></ruby>
                </button>
            </div>
            <div id="rubyResult" class="result-box"></div>
        </div>
    </div>

    <!-- サイト説明 -->
    <div style="margin-top: 60px; padding: 20px; text-align: center; color: #555; font-size: 12px; border-top: 1px solid #e2e8f0;">
        <p style="margin: 0; line-height: 1.6;">
            このサイトは、色々な事情で検索したり、その結果を読むことに課題がある方のために作りました。<br>
            できるだけ多くの人たちが、自分の知りたいことにアクセスできることが願いです。<br>
            <small style="color: #999; margin-top: 10px; display: block;">
                当サイトはGoogle社、Weblio社と提携していません。各サービスの商標は各社に帰属します。
            </small>
        </p>
    </div>

    <script>
        let currentRubyResult = '';
        let currentDictResult = '';
        
        // 音声認識のグローバル管理
        let recognition = null;
        let isRecognizing = false;
        let currentVoiceTarget = 'search'; // 'search' または 'dict'
        
        // API URL設定（ローカル/Vercel自動判定）
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000'
            : window.location.origin;
        
        // デバッグログ（本番では非表示）
        const DEBUG = window.location.hostname === 'localhost';
        if (DEBUG) {
            console.log(`🌐 API Base URL: ${API_BASE}`);
        }
        
        // 音声認識の初期化
        function initVoiceRecognition() {
            if (!recognition) {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    return false;
                }
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.lang = 'ja-JP';
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onstart = () => {
                    if (DEBUG) console.log('🎤 音声認識開始');
                    isRecognizing = true;
                    updateVoiceButtonStatus('listening');
                };
                
                recognition.onresult = (event) => {
                    const result = event.results[0][0].transcript;
                    
                    // 音声入力対象を正しく設定
                    if (currentVoiceTarget === 'search') {
                        document.getElementById('searchInput').value = result;
                    } else if (currentVoiceTarget === 'dict') {
                        document.getElementById('dictInput').value = result;
                    }
                    
                    if (DEBUG) console.log(`🎤 音声認識結果 (${currentVoiceTarget}): "${result}"`);
                    showNotification(`🎤 音声認識成功: "${result}"`, 'success');
                };
                
                recognition.onend = () => {
                    if (DEBUG) console.log('🎤 音声認識終了');
                    isRecognizing = false;
                    updateVoiceButtonStatus('idle');
                };
                
                recognition.onerror = (event) => {
                    console.error('音声認識エラー:', event.error);
                    isRecognizing = false;
                    updateVoiceButtonStatus('idle');
                    
                    let errorMessage = '';
                    switch(event.error) {
                        case 'not-allowed':
                            errorMessage = '🎤 マイクへのアクセスが拒否されました\n\nブラウザのアドレスバー左側のマイクアイコンをクリックして「許可」を選択してください';
                            break;
                        case 'no-speech':
                            errorMessage = '🎤 音声が検出されませんでした。もう一度お試しください。';
                            break;
                        case 'network':
                            errorMessage = '🎤 ネットワークエラーが発生しました。インターネット接続を確認してください。';
                            break;
                        default:
                            errorMessage = `🎤 音声認識エラー: ${event.error}`;
                    }
                    alert(errorMessage);
                };
            }
            return true;
        }
        
        // 音声ボタンの状態更新
        function updateVoiceButtonStatus(status) {
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceDictBtn = document.getElementById('voiceDictBtn');
            
            if (status === 'listening') {
                if (currentVoiceTarget === 'search' && voiceBtn) {
                    voiceBtn.style.background = 'linear-gradient(45deg, #fc8181, #f56565)';
                    voiceBtn.innerHTML = '<ruby>🔴<rt></rt></ruby> <ruby>認<rt>にん</rt></ruby><ruby>識<rt>しき</rt></ruby><ruby>中<rt>ちゅう</rt></ruby>';
                } else if (currentVoiceTarget === 'dict' && voiceDictBtn) {
                    voiceDictBtn.style.background = 'linear-gradient(45deg, #fc8181, #f56565)';
                    voiceDictBtn.innerHTML = '<ruby>🔴<rt></rt></ruby> <ruby>認<rt>にん</rt></ruby><ruby>識<rt>しき</rt></ruby><ruby>中<rt>ちゅう</rt></ruby>';
                }
            } else {
                if (voiceBtn) {
                    voiceBtn.style.background = 'linear-gradient(45deg, #9f7aea, #805ad5)';
                    voiceBtn.innerHTML = '<ruby>🎤<rt></rt></ruby> <ruby>音<rt>おん</rt></ruby><ruby>声<rt>せい</rt></ruby><ruby>入<rt>にゅう</rt></ruby><ruby>力<rt>りょく</rt></ruby>';
                }
                if (voiceDictBtn) {
                    voiceDictBtn.style.background = 'linear-gradient(45deg, #9f7aea, #805ad5)';
                    voiceDictBtn.innerHTML = '<ruby>🎤<rt></rt></ruby> <ruby>音<rt>おん</rt></ruby><ruby>声<rt>せい</rt></ruby><ruby>入<rt>にゅう</rt></ruby><ruby>力<rt>りょく</rt></ruby>';
                }
            }
        }
        
        // 通知表示
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#48bb78' : type === 'error' ? '#f56565' : '#4299e1';
            
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 9999;
                background: ${bgColor}; color: white; padding: 15px 20px;
                border-radius: 10px; font-weight: bold;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                max-width: 300px; word-wrap: break-word;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }
        
        // 1. Google検索機能
        function googleSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('検索したい内容を入力してください');
                return;
            }
            
            const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
            window.open(searchUrl, '_blank');
            if (DEBUG) console.log(`🔍 Google検索: "${query}"`);
        }
        
        // 音声入力機能（検索用）
        function startVoiceSearch() {
            currentVoiceTarget = 'search';
            startVoiceRecognition();
        }
        
        // 辞書用音声入力機能
        function startVoiceDict() {
            currentVoiceTarget = 'dict';
            startVoiceRecognition();
        }
        
        // 共通音声認識開始機能
        function startVoiceRecognition() {
            if (!initVoiceRecognition()) {
                alert('❌ お使いのブラウザは音声認識に対応していません\n\n対応ブラウザ:\n・Google Chrome\n・Microsoft Edge\n・Safari（一部）');
                return;
            }
            
            try {
                if (isRecognizing) {
                    recognition.stop();
                } else {
                    if (recognition.state !== 'inactive') {
                        recognition.abort();
                        setTimeout(() => {
                            recognition.start();
                        }, 100);
                    } else {
                        recognition.start();
                    }
                }
            } catch (error) {
                console.error('音声認識開始エラー:', error);
                isRecognizing = false;
                updateVoiceButtonStatus('idle');
                alert('🎤 音声認識を開始できませんでした。ブラウザがマイクアクセスをブロックしている可能性があります。');
            }
        }
        
        // Weblio辞書で検索
        function searchWeblio() {
            const word = document.getElementById('dictInput').value.trim();
            if (!word) {
                alert('調べたい単語を入力してください');
                return;
            }
            
            const weblioUrl = `https://www.weblio.jp/content_find?query=${encodeURIComponent(word)}&searchType=exact`;
            window.open(weblioUrl, '_blank');
            
            const resultDiv = document.getElementById('dictResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box result-success';
            resultDiv.innerHTML = `
                <div style="padding: 12px;">
                    <div style="font-size: 16px; margin-bottom: 8px; color: #2d3748;">
                        📚 <ruby>Weblio<rt>ウェブリオ</rt></ruby><ruby>辞書<rt>じしょ</rt></ruby>で「${word}」を<ruby>調<rt>しら</rt></ruby>べています ✅ <ruby>新<rt>あたら</rt></ruby>しいタブが<ruby>開<rt>ひら</rt></ruby>きました
                    </div>
                    <div style="background: #e6fffa; padding: 12px; border-radius: 6px; border: 1px solid #4fd1c7;">
                        <div style="font-size: 14px; color: #0f766e;">
                            💡 <ruby>辞書<rt>じしょ</rt></ruby>の<ruby>意味<rt>いみ</rt></ruby>をコピーして、<ruby>下<rt>した</rt></ruby>の「ルビ<ruby>振<rt>ふ</rt></ruby>り」で<ruby>使<rt>つか</rt></ruby>えます
                        </div>
                    </div>
                </div>
            `;
            
            if (DEBUG) console.log(`📚 Weblio辞書検索: "${word}"`);
        }
        
        // 学研キッズ辞書で検索
        function searchGakken() {
            const word = document.getElementById('dictInput').value.trim();
            if (!word) {
                alert('調べたい単語を入力してください');
                return;
            }
            
            const gakkenUrl = `https://kids.gakken.co.jp/jiten/result/?s=${encodeURIComponent(word)}`;
            window.open(gakkenUrl, '_blank');
            
            const resultDiv = document.getElementById('dictResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box result-success';
            resultDiv.innerHTML = `
                <div style="padding: 12px;">
                    <div style="font-size: 16px; margin-bottom: 8px; color: #2d3748;">
                        🏫 <ruby>学研<rt>がくけん</rt></ruby><ruby>辞書<rt>じしょ</rt></ruby>で「${word}」を<ruby>検索<rt>けんさく</rt></ruby> ✅ <ruby>新<rt>あたら</rt></ruby>しいタブが<ruby>開<rt>ひら</rt></ruby>きました
                    </div>
                    <div style="background: #e6fffa; padding: 12px; border-radius: 6px; border: 1px solid #4fd1c7;">
                        <div style="font-size: 14px; color: #0f766e;">
                            💡 <ruby>子<rt>こ</rt></ruby>ども<ruby>向<rt>む</rt></ruby>けの<ruby>分<rt>わ</rt></ruby>かりやすい<ruby>説明<rt>せつめい</rt></ruby>が<ruby>見<rt>み</rt></ruby>つかります
                        </div>
                    </div>
                </div>
            `;
            
            if (DEBUG) console.log(`🏫 学研辞書検索: "${word}"`);
        }
        
        // 辞書セクション消去
        function clearDict() {
            document.getElementById('dictInput').value = '';
            document.getElementById('dictResult').style.display = 'none';
            currentDictResult = '';
            if (DEBUG) console.log('🗑️ 辞書セクション消去');
        }
        
        // 🆕 Yahoo! APIルビ振り機能（段落対応版）
        async function addRuby() {
            const text = document.getElementById('rubyInput').value.trim();
            if (!text) {
                alert('ルビを振りたい文章を入力してください');
                return;
            }
            
            if (text.length > 2000) {
                alert('文章が長すぎます。2000文字以内にしてください。');
                return;
            }
            
            const resultDiv = document.getElementById('rubyResult');
            const rubyBtn = document.getElementById('rubyBtn');
            const copyBtn = document.getElementById('copyBtn');
            
            // 段落構造検出
            const hasParagraphs = text.includes('\n') || /[◆●▲■♦]/.test(text);
            const paragraphInfo = hasParagraphs ? '📋 段落構造を検出しました' : '📄 単一段落として処理します';
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-box result-loading';
            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">⚡</div>
                    <div>Yahoo! Text Analytics API でルビを振っています...</div>
                    <div style="font-size: 14px; color: #666; margin-top: 5px;">
                        ${paragraphInfo}
                    </div>
                </div>
            `;
            rubyBtn.disabled = true;
            copyBtn.style.display = 'none';
            
            try {
                if (DEBUG) console.log(`🌐 Yahoo! API呼び出し: ${API_BASE}/api/ruby-yahoo`);
                
                const response = await fetch(`${API_BASE}/api/ruby-yahoo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text: text, 
                        grade: 1,
                        preserveParagraphs: true // 🆕 段落保持を有効化
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'レスポンス取得失敗');
                    throw new Error(`サーバーエラー: ${response.status} ${response.statusText}\n詳細: ${errorText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    currentRubyResult = data.rubyText;
                    
                    // 🆕 段落モード表示
                    const modeText = data.paragraphMode ? '📋 段落構造保持モード' : '📄 シンプルモード';
                    
                    resultDiv.className = 'result-box result-success';
                    resultDiv.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 15px; color: #2d3748;">
                            ✨ Yahoo! API ルビ振り完了！ (${modeText})
                        </div>
                        <div style="padding: 20px; background: #fff; border-radius: 10px; border: 2px solid #e2e8f0; line-height: 2.2;">
                            ${data.rubyText}
                        </div>
                        <div class="stats">
                            📊 ${text.length}文字 → ${data.segmentCount}セグメント処理完了 | ${data.provider}
                        </div>
                    `;
                    
                    copyBtn.style.display = 'flex';
                    document.getElementById('speakBtn').style.display = 'flex';
                    document.getElementById('stopBtn').style.display = 'flex';
                    if (DEBUG) console.log(`✨ Yahoo! API ルビ振り完了: ${data.segmentCount}セグメント (段落モード: ${data.paragraphMode})`);
                } else {
                    throw new Error(data.error || 'ルビ振り処理でエラーが発生しました');
                }
                
            } catch (error) {
                console.error('Yahoo! API ルビ振りエラー:', error);
                resultDiv.className = 'result-box result-error';
                resultDiv.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="font-size: 1.2em; margin-bottom: 15px; color: #c53030;">
                            ❌ Yahoo! API エラー
                        </div>
                        <div style="background: #fed7d7; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <strong>エラー内容:</strong><br>
                            ${error.message}
                        </div>
                        <div style="background: #e6fffa; padding: 15px; border-radius: 8px;">
                            <strong>💡 解決方法:</strong><br>
                            ・Yahoo! APIキーの設定を確認してください<br>
                            ・少し時間をおいて再度お試しください<br>
                            ・文章を短くしてお試しください
                        </div>
                    </div>
                `;
            } finally {
                rubyBtn.disabled = false;
            }
        }
        
        // ルビセクション消去
        function clearRuby() {
            document.getElementById('rubyInput').value = '';
            document.getElementById('rubyResult').style.display = 'none';
            document.getElementById('copyBtn').style.display = 'none';
            document.getElementById('speakBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
            currentRubyResult = '';
            
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
            
            if (DEBUG) console.log('🗑️ ルビセクション消去');
        }
        
        // ルビ振り結果の読み上げ機能
        function speakRubyResult() {
            if (!currentRubyResult) {
                alert('読み上げる内容がありません');
                return;
            }
            
            if (!('speechSynthesis' in window)) {
                alert('お使いのブラウザは音声読み上げに対応していません');
                return;
            }
            
            // ルビを除去して本文のみを抽出（改良版）
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = currentRubyResult;
            
            // <rt>タグ（ルビ部分）を全て削除
            const rtElements = tempDiv.querySelectorAll('rt');
            rtElements.forEach(rt => rt.remove());
            
            // 段落系要素の後に改行追加
            const paragraphElements = tempDiv.querySelectorAll('.paragraph-heading, .paragraph-content, .paragraph-break');
            paragraphElements.forEach(el => {
                el.innerHTML = el.innerHTML + '\n\n';
            });
            
            // 見出し・太字要素の後に改行追加
            const headingElements = tempDiv.querySelectorAll('h1, h2, h3, h4, h5, h6, strong, b');
            headingElements.forEach(el => {
                el.innerHTML = el.innerHTML + '\n';
            });
            
            // ブロック要素の後に改行追加
            const blockElements = tempDiv.querySelectorAll('div, p, li');
            blockElements.forEach(el => {
                el.innerHTML = el.innerHTML + '\n';
            });
            
            // 本文のみを取得
            const textToSpeak = tempDiv.textContent || tempDiv.innerText || '';
            
            if (!textToSpeak.trim()) {
                alert('読み上げる文章がありません');
                return;
            }
            
            speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.8;
            utterance.pitch = 1.1;
            utterance.volume = 0.9;
            
            const speakBtn = document.getElementById('speakBtn');
            
            utterance.onstart = () => {
                speakBtn.style.background = 'linear-gradient(45deg, #fc8181, #f56565)';
                speakBtn.innerHTML = '<ruby>🔊<rt></rt></ruby> <ruby>読<rt>よ</rt></ruby><ruby>み<rt></rt></ruby><ruby>上<rt>あ</rt></ruby><ruby>げ<rt></rt></ruby><ruby>中<rt>ちゅう</rt></ruby>';
                if (DEBUG) console.log('🔊 読み上げ開始');
                showNotification('🔊 読み上げています...', 'info');
            };
            
            utterance.onend = () => {
                speakBtn.style.background = 'linear-gradient(45deg, #48bb78, #38a169)';
                speakBtn.innerHTML = '<ruby>🔊<rt></rt></ruby> <ruby>読<rt>よ</rt></ruby><ruby>み<rt></rt></ruby><ruby>上<rt>あ</rt></ruby><ruby>げ<rt></rt></ruby>';
                if (DEBUG) console.log('🔊 読み上げ完了');
                showNotification('✅ 読み上げが完了しました', 'success');
            };
            
            utterance.onerror = (event) => {
                console.error('読み上げエラー:', event.error);
                speakBtn.style.background = 'linear-gradient(45deg, #48bb78, #38a169)';
                speakBtn.innerHTML = '<ruby>🔊<rt></rt></ruby> <ruby>読<rt>よ</rt></ruby><ruby>み<rt></rt></ruby><ruby>上<rt>あ</rt></ruby><ruby>げ<rt></rt></ruby>';
                showNotification('❌ 読み上げでエラーが発生しました', 'error');
            };
            
            speechSynthesis.speak(utterance);
        }
        
        // 読み上げ停止機能
        function stopSpeaking() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                
                const speakBtn = document.getElementById('speakBtn');
                speakBtn.style.background = 'linear-gradient(45deg, #48bb78, #38a169)';
                speakBtn.innerHTML = '<ruby>🔊<rt></rt></ruby> <ruby>読<rt>よ</rt></ruby><ruby>み<rt></rt></ruby><ruby>上<rt>あ</rt></ruby><ruby>げ<rt></rt></ruby>';
                
                if (DEBUG) console.log('⏹️ 読み上げ停止');
                showNotification('⏹️ 読み上げを停止しました', 'info');
            }
        }
        
        // 結果をコピー（Word貼り付け対応）
        function copyResult() {
            if (!currentRubyResult) {
                alert('コピーする結果がありません');
                return;
            }
            
            try {
                const optimizedHTML = `
                    <div style="font-family: 'BIZ UDPゴシック', 'Yu Gothic UI', 'Meiryo UI', 'Hiragino Sans', sans-serif; font-size: 16px; line-height: 2.2;">
                        ${currentRubyResult.replace(/<ruby>/g, '<ruby style="font-size: 16px;">').replace(/<rt>/g, '<rt style="font-size: 8px; color: #666;">')}
                    </div>
                `;
                
                const plainText = currentRubyResult.replace(/<[^>]*>/g, '');
                
                if (navigator.clipboard && navigator.clipboard.write) {
                    const clipboardItem = new ClipboardItem({
                        'text/html': new Blob([optimizedHTML], { type: 'text/html' }),
                        'text/plain': new Blob([plainText], { type: 'text/plain' })
                    });
                    
                    navigator.clipboard.write([clipboardItem]).then(() => {
                        showCopySuccess('Word最適化版');
                        if (DEBUG) console.log('📋 Word最適化HTML + テキストをコピー完了');
                    }).catch(err => {
                        if (DEBUG) console.log('HTML+テキストコピー失敗、フォールバック実行');
                        fallbackCopy();
                    });
                } else {
                    fallbackCopy();
                }
                
            } catch (error) {
                console.error('コピーエラー:', error);
                alert('コピーに失敗しました');
            }
        }
        
        function fallbackCopy() {
            const textArea = document.createElement('textarea');
            textArea.value = currentRubyResult.replace(/<[^>]*>/g, '');
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showCopySuccess('テキスト版');
            if (DEBUG) console.log('📋 テキストをコピー完了（フォールバック）');
        }
        
        function showCopySuccess(type) {
            const notification = document.createElement('div');
            notification.className = 'copy-success';
            notification.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">📋 コピー完了！</div>
                <div style="font-size: 13px;">
                    ${type}をコピーしました<br>
                    Wordに貼り付けると文字16px、ルビ8pxで表示されます
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 4000);
        }
        
        // キーボードショートカット
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'Enter':
                        if (document.activeElement.id === 'searchInput') {
                            e.preventDefault();
                            googleSearch();
                        } else if (document.activeElement.id === 'dictInput') {
                            e.preventDefault();
                            searchWeblio();
                        } else if (document.activeElement.id === 'rubyInput') {
                            e.preventDefault();
                            addRuby();
                        }
                        break;
                    case 'c':
                        if (currentRubyResult && document.activeElement.id === 'rubyInput') {
                            e.preventDefault();
                            copyResult();
                        }
                        break;
                }
            }
        });
        
        // ページ読み込み完了時（デバッグメッセージを本番では非表示）
        window.addEventListener('load', () => {
            if (DEBUG) {
                console.log('📚 調べる窓口 v4.0 - 段落機能付き完全版準備完了！');
                console.log(`🌐 動作環境: ${API_BASE === window.location.origin ? 'Vercel本番' : 'ローカル開発'}`);
                console.log(`🔌 API接続先: ${API_BASE}/api/ruby-yahoo`);
                console.log('⌨️  ショートカット: Ctrl+Enter=実行, Ctrl+C=コピー');
                console.log('✅ タイトル: 調べる窓口（ルビ付き）');
                console.log('✅ 法的配慮: Google・Weblio非提携明記');
                console.log('🆕 段落機能: 改行・見出しマーク自動検出');
            }
            
            document.getElementById('searchInput').focus();
        });
    </script>
</body>
</html>